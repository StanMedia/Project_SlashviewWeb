<!DOCTYPE html><html><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1" /><link href=/.file/site.css rel=stylesheet /><script src=/.include/jquery/jquery.min.js></script></head><body><header></header><main><h1>FTP可以登入，但是無法列舉目錄</h1><p>有時候我們需要在Server上進行一些FTP的傳輸，但是當我們打開命令模式下的FTP操作時，卻發現一件很詭異的事情，明明可以登入，並輸入帳號密碼，但是卻無法列舉目錄。例如你下ls或dir指令，他的畫面卡在...</p><pre><code class=language-txt>150 Opening data channel for directory list
</code></pre><p>這時候有經驗的老手，可能會直接進防火牆，把ftp.exe這個程式設定成允許就好了，一般的情況下是沒問題的。但如果你是要「測試」你的伺服器的「服務」（例如：ASP.NET, PHP ...），是不是因為被防火牆擋住的關係，因此無法連線成功，那你這樣的動作就顯得毫無意義，因為你允許了ftp.exe不代表你的服務也同時被允許啊。</p><p>讓我們來複習一下FTP Active Mode的傳輸過程</p><ol><li>Client用一個亂數的Port X（例如：1024）跟Server的Port 21敲門。（所以Server的Port 21要開啟，這個Port做為Command用）</li><li>Server的Port 21回應Port X，說我活著。</li><li>接下來Server自動開啟Port 20，把資料傳過去Port X+1（例如：1025）。（所以Server的Port 1025要開啟）</li><li>Client持續用Port X+1回應Server Port 20，說我收到資料了，請傳下一個封包。（所以Server的Port 21要開啟，這個Port做為Data傳輸用）</li><li>就此往返最後兩項的封包傳遞...</li></ol><p>Server的Port Mapping很明顯的就是要開20, 21，但這不是我們今天要討論的對象。上面程序的重點是，我怎麼知道Port X是幾號？沒錯，Port X是在運行時期取決於Socket空值動態決定的，不是我們在一開始就可以制定的。特別是ASP.NET或PHP等服務調用的DLL，大部份的時候底層的連線細節都不是你可以控制的。</p><p>因此我們只能針對防火牆開刀了，在這邊我們使用Windows 7來進行解說：</p><ol><li>呼叫進階防火牆：Windows + R > cmd > wf.msc</li><li>點選：輸入規則 > 新增規則</li><li>連接埠 > TCP > 所有本機連接埠</li><li>允許連線</li><li>「網域、私人、公用」是否要全勾，請自己決定</li><li>輸入一個可視別的名稱，例如：FTP Data Port</li><li>按確定後回到進階防火牆畫面，點選你剛建立的FTP Data Port規則，選內容。</li><li>接下來的內容設定，請看下圖說明：</li></ol><p><img src=https://content.slashview.com/img/2013/20131017_01.jpg alt="" /></p><p>大功告成，請開心的連線吧！請注意，這樣的防火牆設定意味著由Port 20所發出的連線要求，你的伺服器都要吃，這將會帶來一些風險，所以請自行斟卓要不要設定。另外一條路你也可以參考看看，例如去設定服務在背景運行的身分之存取網路權限？</p><h6>FTP Port FireWall Windows Server</h6></main><footer></footer><script src=/.file/site.js></script><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7039045520564660"></script></body></html>