<!DOCTYPE html><html><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1" /><link href=/.file/site.css rel=stylesheet /><script src=/.include/jquery/jquery.min.js></script></head><body><header></header><main><h1>Apache Bench壓力測試平行要求數的增加與相關知識</h1><p>今天在Windows 7下進行Apache Bench（ab.exe）時候，發現一個很詭異的問題，就是-c參數（concurrency）的調整，永遠不能夠大於64，也就是說，你一調整到65就會丟出錯誤給你。</p><p>例如像這個錯誤：</p><pre><code class=language-txt>apr_pollset_create failed: Invalid argument (22)
</code></pre><p>翻遍網路，只有一兩篇在講這個事情，而且會把解決方案導向到叫你去改Windows Registry，去regedit一些HTTP Connection Max相關的東西，我只能說，千萬不要，因為根本就沒有用！</p><p>真實的答案很簡單，就是你的ab.exe是舊版本（This is ApacheBench, Version 2.0.41），沒錯，就是這麼簡單，換新版的就好了。請到<a href=http://goo.gl/ySdR>Apache基金會官方網站</a>下載，解出裡面的ab.exe（This is ApacheBench, Version 2.3）就可以用了。</p><p>懶得下載的人，請點選這裡服用：<a href=https://content.slashview.com/file/20140320/ab.zip>ab.exe</a> Download!</p><pre><code class=language-txt>//於是你就可以大方的下指令了！Success!!
ab -n 1000 -c 100 http://www.google.com/
</code></pre><h3>有關於ab.exe壓力測試有關的參數說明</h3><ol><li>-n 1000：代表這一次的整體測試執行中，總共會發出1000個連線。</li><li>-c 100：代表這一次的整體測試執行中，每一次壓測作業，同時間會併行使用100條連線。</li><li>承上「-n 1000 -c 100」，也就是說總共會循換做10次，每次100個連線，總共會發出1000個連線壓測。</li></ol><h3>有關於ab.exe壓力測試有關的回應說明</h3><ol><li>Server Software: Web主機的作業系統與版本（若Web主機設定關閉此資訊則無）</li><li>Server Hostname: Web主機的IP位址（Hostname）</li><li>Server Port: Web主機的連接埠（Port）</li><li>Document Path: 測試網址的路徑部分</li><li>Document Length: 測試網頁回應的網頁大小</li><li>Concurrency Level: 同時進行壓力測試的人數</li><li>Time taken for tests: 本次壓力測試所花費的總秒數</li><li>Complete requests: 完成的要求數（Requests）</li><li>Failed requests: 失敗的要求數（Requests）</li><li>Write errors: 寫入失敗的數量</li><li>Total transferred: 本次壓力測試的總數據傳輸量（包括 HTTP Header 的資料也計算在內）</li><li>HTML transferred: 本次壓力測試的總數據傳輸量（僅計算回傳的 HTML 的資料）</li><li>Requests per second: 平均每秒可回應多少要求</li><li>Time per request: 平均每個要求所花費的時間（單位: 豪秒）</li><li>Time per request: 平均每個要求所花費的時間，跨所有同時連線數的平均值（單位: 豪秒）</li><li>Transfer rate: 從壓測主機到WebServer之間的網路傳輸速度</li></ol><p>Connection Times（ms）／壓力測試時的連線處理時間，詳細意義如下：</p><p>橫軸：</p><ol><li>min: 最小值</li><li>mean: 平均值（正、負標準差）</li><li>median: 平均值（中間值）</li><li>max: 最大值</li></ol><p>縱軸：</p><ol><li>Connect: 從壓測主機發出TCP要求到Web主機，所花費的建立時間</li><li>Processing: 從TCP連線建立後，直到HTTP回應的資料全部都收到，所花的時間</li><li>Waiting: 從發送HTTP要求完後，到HTTP回應第一個Byte，所等待的時間</li><li>Total: 等於「Connect + Processing」的時間（因為Waiting已經包含在Processing內了）</li></ol><h2>有關於ab.exe壓力測試Failed requests的說明</h2><p>在壓力測試的結果中，常常會有那種爆棚式的錯誤數據跑出來，如果你的測試是落在動態網頁（ASP.NET、PHP、JSP...）的運行範疇內，那其實這樣的結果並不用太驚訝，請看下面這個WTF等級的例子：</p><pre><code class=language-txt>Complete requests: 1000
Failed requests:    990 (Connect: 0, Length: 990, Exceptions: 0)
</code></pre><p>甚麼，送出一千次的要求，竟然有九百九十次的錯誤，網站再怎麼爛也不可能是這樣的錯誤法吧？別緊張請觀察一下是不是都是Length方面的錯誤，如果是的話，可以嘗試下列這樣解釋。</p><p>基本上，ab會把第一次收到的Response資料，記錄其Header的Content-Length數據，假設這個內容的長度是X。當你第2次～第1000次要求若跟這個X資料長度不一樣時，ab就會將其認列並記載在Failed requests的Length的計數器當中。</p><p>請基於上面的運作原理來解釋你的錯誤問題，如果你的壓測網址，該頁面會亂數回應你長度不一的訊息畫面（例如亂數模擬不同的身分登入操作），那麼這個Failed requests你完全可以忽略不計。如果你的壓測網址，該頁面永遠會固定回應給你一個靜態畫面（例如永遠模擬同一個身分登入進行操作），那這個Failed requests你或許就要再多琢磨看看了。</p><p>若在壓測時期，出現有關於apr_poll: The timeout specified has expired (70007)的錯誤：這個錯誤「有可能」是你的伺服器覺得壓力來源端開太多，因此試圖阻擋所致。要排除這個問題的話，不妨在指令列裡面添加「-k」參數（Use HTTP KeepAlive feature）試著修正看看。</p><h6>ApacheBench Concurrency Maximum 64 Increase Command FailedRequests</h6></main><footer></footer><script src=/.file/site.js></script></body></html>