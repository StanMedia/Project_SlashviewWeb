<!DOCTYPE html><html><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1" /><link href=/.file/site.css rel=stylesheet /><script src=/.include/jquery/jquery.min.js></script></head><body><header></header><main><h1>使虛擬機GuestOS與DockerContainer可以進行TCP通訊</h1><p>事情有點複雜，情況是這樣的：有一台電腦，安裝了VMware與Docker Desktop</p><ol><li><p>Docker已經啟用一組<code>Container</code>（假設是Ollama），且已經與host的11434 port完成映射。當我們使用http://localhost:11434可以證明ollama正常運行。</p></li><li><p>VMware已經啟用一組<code>GuestOS</code>，網路採用的是<a href=https://slashview.com/archive2024/20240313.html>Host-Only架構</a>，Guest OS IP為<code>192.168.1.2</code>。</p></li><li><p>想要解決的問題：透過<code>VMware GuestOS</code>輸入<code>curl http://192.168.1.1:11434</code>，預期可以連接到<code>Docker Container</code>服務，但事實上卻<code>沒有任何回應</code>。</p></li><li><p>初步除錯：在Host上面輸入<code>http://192.168.1.1:11434</code>確定有回應。</p></li></ol><h2>VirtualMachine與Docker無法通訊的原因</h2><p>經過努力排查出問題原因出在Windows防火牆的<code>輸入規則</code>所致，也就是如果把整個Windows防火牆關閉，上述的第三點問題就可迎刃而解。再細部查看問題出在Docker Desktop安裝完成後，基於安全性原因自動設定了一個全域拒絕的規則：</p><pre><code class=language-txt>🚫 Docker Desktop Backend
</code></pre><p>這個規則拒絕了所有<code>外部</code>試圖連入的TCP、UDP連線，這時候我立即想到的是設定例外規則來排除，但是Windows防火牆的規則為只要是<code>明確拒絕的規則</code>，無論再後續新增怎樣例外的規則都會被忽略。因此現在的待處理目標變成：</p><pre><code class=language-txt>如何保有這個安全的防火牆規則，又可以開放讓特定的連線進入使用？
</code></pre><p>※ 特別說明：這個規則預設是<code>封鎖連線</code>且<code>已啟用</code>，但就算在Windows防火牆將這個規則<code>停用</code>，那麼Docker預設還是拒絕所有的連線。唯一設定是<code>允許連線</code>且<code>已啟用</code>，才可以讓我們想要讓兩者可通訊的問題解決，但，這並非我們想要的答案。（這樣就不安全了）</p><h2>針對Docker Desktop Backend兼具安全又具備特定開放條件的設定</h2><p>Step 1. 按下<code>Windows + R</code>，輸入<code>wf.msc</code>呼叫出<code>具有進階安全性的Windows Defender防火牆</code>。</p><p>Step 2. 在<code>輸入規則</code>頁籤中，找到<code>TCP協定</code>的<code>Docker Desktop Backend</code>輸入規則並編輯。</p><p>Step 3. 找到<code>主機本體</code>頁籤，在<code>例外</code>欄位中新增一個<code>本機使用者</code>身分，名為：<code>__vmware__</code>，其實這是一個用來存放VMware User Group的群組名稱。這樣一來來自VMware的使用者連線就可以跳過這個<code>Docker Desktop Backend</code>的絕對拒絕連線規則。</p><p><img src=https://content.slashview.com/img/2025/20250117_01.jpg alt="" /></p><p>Step 4. 新增一個規則：</p><ol><li>名為<code>Allow VMware to Ollama</code>，<code>已啟用</code>且<code>允許連線</code>。</li><li>在<code>通訊協定及連接埠</code>頁籤選擇通訊協定類型：<code>TCP</code>、本機連接埠：<code>11434</code>。</li><li>在<code>領域</code>頁籤的<code>遠端IP位址</code>新增<code>192.168.1.2</code>，透過更嚴謹的IP設定來防範可能的漏洞。</li></ol><p><img src=https://content.slashview.com/img/2025/20250117_02.jpg alt="" /></p><p>透過上面的Windows防火牆設定後，我們就可以在VMware GuestOS裡面，透過cURL連線到Docker的ollama container啦！</p><h6>VMware GuestOS HostOS Docker Container Connection Connect WindowsFirewall Setup</h6></main><footer></footer><script src=/.file/site.js></script></body></html>