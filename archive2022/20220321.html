<!DOCTYPE html><html><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1" /><link href=/.file/site.css rel=stylesheet /><script src=/.include/jquery/jquery.min.js></script></head><body><header></header><main><h1>SQL筆記：外部索引鍵FOREIGN KEY條件約束的設定</h1><p>在關聯式資料庫中，外部索引鍵是一個很重要的觀念這裡紀錄兩種很常用到的設定（插入不存在、連動刪除），供給有需要的人參考。以下先簡介一下當前範例資料庫的結構，有一個TEST_TABLE_Event表用來儲存活動的資料，而TEST_TABLE_PlaceExtend表用來存放場地的延伸介紹資訊，我們利用SSMS在關聯式資料庫中建立圖表如下圖：</p><p>這個簡單的資料關聯圖有一個很大的問題，就是管理者不一定會在延伸資料表（TEST_TABLE_PlaceExtend），屆時動作是如果管理者有新增延伸資料表的場地資訊，我們才把資訊打出來檢視，如果查無延伸資料就算了（null），簡單的說屆時會以LEFT OUTER JOIN的方法來進行檢視表的組合。</p><p><img src=https://content.slashview.com/img/2022/20220321_01.jpg alt="" /></p><h2>插入一筆外來鍵不存在的空資料</h2><p>一開始TEST_TABLE_PlaceExtend資料表在沒有任何一筆資料的情況下，我們想要對TEST_TABLE_Event新增（INSERT）一筆資料，馬上會遇到一個問題：</p><p>儲存職缺資料過程發生問題：執行錯誤／INSERT 陳述式與 FOREIGN KEY 條件約束 "FK_TEST_TABLE_Event_TEST_TABLE_PlaceExtend" 衝突。衝突發生在資料庫 "OOO"，資料表 "dbo.TEST_TABLE_PlaceExtend", column 'cPlaceCode'。 陳述式已經結束。</p><p>上面這個錯誤講白話一點就是：啊！你在TEST_TABLE_Event裡面的cPlaceCode填入一個「A1234」（假設），但是我在TEST_TABLE_PlaceExtend裡面找不到「A1234」這個鍵值啊？</p><h2>解決方法</h2><p>在SSMS裡面打開資料庫圖表，點選要處理的關聯線右鍵選擇屬性，然後會看到一個屬性名為「強制使用外部索引鍵條件約束」，將其從「是」改為「否」即可，改完後可以順便發現線條圖案變成了虛線了，亦可發現已經可以順利的在TEST_TABLE_Event裡面插入資料嘍！</p><p><img src=https://content.slashview.com/img/2022/20220321_02.jpg alt="" /></p><h2>補充說明</h2><p>上面這個狀況是因為把延伸資料表（TEST_TABLE_PlaceExtend）當作TYPE表來參考使用，也就是Event表的cPlaceCode參考的值是另外一張表的「鍵值」才因此觸發這個問題出現，反之的話這議題就不會發生。舉例來說，Event表的PK-iAutoIndex參考到一張名為TEST_TABLE_Guest的資料表（紀錄來參加這Event的來賓），由於這將會形成一對多的關係，因此Guest資料表肯定會設定一個自動產生序號的PK欄位（有如Event表的PK-iAutoIndex），而Event表的PK-iAutoIndex關連到的應該是屬於Guest資料表的某一個整數欄位，例如名為iMap2Event。在這樣的情況下，就不會發生「INSERT 陳述式與 FOREIGN KEY 條件約束」的錯誤。</p><h2>連動刪除（重疊顯示）</h2><p>這個問題在資料庫中很常發生，大致上就是你想要在TEST_TABLE_PlaceExtend資料表把一筆資料刪除時（這筆資料的鍵值已經被TEST_TABLE_Event裡面的某一筆資料參考），會出現這樣的錯誤訊息：</p><p>DELETE 陳述式與 REFERENCE 條件約束 "FK_TEST_TABLE_Event_TEST_TABLE_PlaceExtend" 衝突。衝突發生在資料庫 "OOO"，資料表 "TEST_TABLE_Event", column 'cPlaceCode'。 陳述式已經結束。</p><p>上面這個錯誤講白話一點就是：啊！你要刪除的TEST_TABLE_PlaceExtend裡面的cPlaceCode鍵值已經被TEST_TABLE_Event拿去參考了，因此我不要讓你砍。</p><h2>解決方法</h2><p>總共有兩種解決方式，第一種就是請SQL Server不要再雞婆了，請實作上面描述的：「強制使用外部索引鍵條件約束」設定為「否」即可。</p><p>另外一種就是把拿鍵值去參考的表（TEST_TABLE_Event）裡面的資料一併砍掉，一般來說可以設定成自動化連動刪除（把TEST_TABLE_Event裡面關聯的資料一併順便都刪除掉），這時候可以在關聯線右鍵選擇屬性，把「INSERT及UPDATE規格」選項展開，點選「刪除規則」＞「重疊顯示」即可連動刪除。</p><p>值得注意的是，「重疊顯示」的優先權低於「強制使用外部索引鍵條件約束」，所以如果你已經請SQL Server「強制使用外部索引鍵條件約束：否」並且設定「刪除規則：重疊顯示」，那麼當你去TEST_TABLE_PlaceExtend刪除資料時，這時候SQL Server將不會連動刪除TEST_TABLE_Event的資料。</p><h6>SQL 關聯 Relation 新增 INSERT 刪除 DELETE 外來鍵 FK ForeignKey Setting Setup</h6></main><footer></footer><script src=/.file/site.js></script></body></html>