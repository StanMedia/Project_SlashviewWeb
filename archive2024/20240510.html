<!DOCTYPE html><html><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1" /><link href=/.file/site.css rel=stylesheet /><script src=/.include/jquery/jquery.min.js></script></head><body><header></header><main><h1>擴增Ubuntu的硬碟容量（LVM）</h1><p>在Linux環境下擴增磁碟容量，跟Partition based的Windows比較起來還真的不是普通的複雜，不過這些觀念與設定都是為了日後擴增應用上的彈性。這個範例將步驟記錄在此以利日後查詢，指令預設先一律<code>sudo -i</code>開始。</p><h2>LVM觀念</h2><p>LVM（Logical Volume Manager）中文為邏輯捲軸管理員，透過下圖複雜的邏輯層切割，來讓大型伺服系統可以用更彈性的方式來調整磁碟空間。首先看一下下面這張圖：</p><p><img src=https://content.slashview.com/img/2024/20240510_01.jpg alt="" /></p><p>Linux透過下面這三個邏輯架構將系統與實體裝置切開，日後硬體的資源將可以透過邏輯的方式被直接使用，不用再經過備份、搬移、還原等步驟。</p><ul><li>ＬＶ（Logical Volume）邏輯卷：邏輯層的Partition，某個檔案系統目錄可以指向要用哪個LV。</li><li>ＶＧ（Volume Group）卷組：邏輯層的硬碟，一個VG可以由數個PV聯合組立。當VG建立後，內部會有名為PE（Physical Extent）的無數小區塊出現，這個我們可以視為傳統硬碟的Block。</li><li>ＰＶ（Physical Volume）實體卷：某個實體硬碟中切出的Partition就是一個PV。</li></ul><h2>硬碟環境檢視</h2><p>首先檢試一下當前的磁碟機以及磁碟分割區：</p><pre><code class=language-txt>fdisk -l
</code></pre><p>我們可以發現有一顆名為<code>/dev/sda</code>的20GB硬碟，並且被分割成三個Partition（sda1、sda2、sda3），另外也可以瞥見名為<code>/dev/mapper/ubuntu--vg-ubuntu--lv</code>的LV出現。</p><p><img src=https://content.slashview.com/img/2024/20240510_02.jpg alt="" /></p><p>接著馬上輸入指令來檢視LV的相關狀態：</p><pre><code class=language-txt>lvdisplay
</code></pre><p>我們發現了事實是，<code>/dev/mapper/ubuntu--vg-ubuntu--lv</code>這個LV是由<code>ubuntu-vg</code>這個VG切出，且不知道為何只有給10GB？這代表屬於LV</p><p><img src=https://content.slashview.com/img/2024/20240510_03.jpg alt="" /></p><p>整理一下目前的發現，輸入下列指令列出關係圖：</p><pre><code class=language-txt>lsblk
</code></pre><p><img src=https://content.slashview.com/img/2024/20240510_04.jpg alt="" /></p><p>接著透過下列指令來查詢VG的相關狀態：</p><pre><code class=language-txt>vgdisplay
</code></pre><p>我們可以看出這個VG採用的是<code>lvm2</code>格式，SIZE為<code>18.22GB</code>，其中已經分配了10GB出去了（Alloc PE / Size），還有8.22GB的PE尚未分配（Free PE / Size）。</p><p><img src=https://content.slashview.com/img/2024/20240510_05.jpg alt="" /></p><h2>擴增硬碟容量</h2><p>因為我是VM環境所以可以針對虛擬硬碟進行邏輯上的擴增，我這邊打算把20GB擴增到40GB，首先把作業系統關機後，到VMware裡面針對硬碟進行<code>Expand</code>擴增。</p><p><img src=https://content.slashview.com/img/2024/20240510_06.jpg alt="" /></p><p>開機後為了要方便的擴增容量，可以請<code>parted</code>程式來幫忙，若無可先下載：</p><pre><code class=language-txt>apt-get install parted
</code></pre><p>執行<code>parted</code>後可輸入<code>print</code>指令查看狀態，可以看到<code>/dev/sda</code>磁碟機已經變成<code>42.9GB</code>，但是<code>分割區編號3</code>的容量仍然是<code>19.6GB</code>：</p><p><img src=https://content.slashview.com/img/2024/20240510_07.jpg alt="" /></p><p>接著按照下列指令輸入來延伸磁區：</p><pre><code class=language-txt>(parted) resizepart
Partition number? 3
End? [21.5GB]? 100%
</code></pre><p>最後再print確認一次狀態確定已經擴充到<code>40GB</code>完成了（41.0GB），可以輸入<code>quit</code>離開並<code>reboot</code>。</p><p><img src=https://content.slashview.com/img/2024/20240510_08.jpg alt="" /></p><h2>擴增LVM容量</h2><p>重開機後開心地輸入<code>pvdisplay</code>看看容量有沒有擴增，結果發現並沒有，依然維持在<code>18GB</code>。</p><p><img src=https://content.slashview.com/img/2024/20240510_09.jpg alt="" /></p><p>輸入下列指令更新PV容量大小：</p><pre><code class=language-txt>pvresize /dev/sda3
</code></pre><p>完成後馬上<code>pvdisplay</code>確認，發現PV的容量改變為<code>38.23GB</code>了：</p><p><img src=https://content.slashview.com/img/2024/20240510_10.jpg alt="" /></p><p>接著輸入<code>lvdisplay</code>確認依然停留在<code>10GB</code>：</p><p><img src=https://content.slashview.com/img/2024/20240510_11.jpg alt="" /></p><p>接下來就是準備將VG剩餘的PE空間，全部<code>100%</code>都讓給LV的時刻了。請輸入下列指令：</p><pre><code class=language-txt>lvextend -l +100%FREE /dev/ubuntu-vg/ubuntu-lv
</code></pre><p>系統會返回下列訊息，代表LV已經由原本占用2560PE，提升變成佔用了9785PE：</p><pre><code class=language-txt>Size of logical volume ubuntu-vg/ubuntu-lv changed from 10.00 GiB (2560 extents) to 38.22 GiB (9785 extents).
Logical volume ubuntu-vg/ubuntu-lv successfully resized.
</code></pre><p>再來一次<code>lvdisplay</code>確認已經LV Size升級到<code>38.22GB</code>：</p><p><img src=https://content.slashview.com/img/2024/20240510_12.jpg alt="" /></p><h2>將LV的空間更新到檔案系統</h2><p>做到這邊還別高興，你還要輸入指令將LV的空間釋放給檔案系統（File System），我們先輸入磁碟檢查指令看看：</p><pre><code class=language-txt>df -h
</code></pre><p>可以看到<code>/dev/mapper/ubuntu--vg-ubuntu--lv</code>這個LV依然是<code>10GB</code>...</p><p><img src=https://content.slashview.com/img/2024/20240510_13.jpg alt="" /></p><p>輸入指令讓LV的新容量釋放給檔案系統</p><pre><code class=language-txt>resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv
</code></pre><p>在檢查一次磁碟容量，透過檔案系統來確定LV的可用空間為<code>38GB</code>。</p><p><img src=https://content.slashview.com/img/2024/20240510_14.jpg alt="" /></p><p>至此，硬碟容量擴充總算大功告成。</p><h6>Linux Ubuntu Disk LVM LVM2 Capacity Expand Extend</h6></main><footer></footer><script src=/.file/site.js></script></body></html>