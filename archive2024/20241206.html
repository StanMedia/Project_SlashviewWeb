<!DOCTYPE html><html><head><meta charset=utf-8 /><meta name=viewport content="width=device-width, initial-scale=1" /><link href=/.file/site.css rel=stylesheet /><script src=/.include/jquery/jquery.min.js></script></head><body><header></header><main><h1>ASP.NET下載大型檔案有時會發生中斷的問題</h1><p>近日發現網站在下載大型檔案的時候，檔案會呈現時好時壞的現象。時好時壞自然與程式碼無關了（如果程式碼有問題，那怎麼可能可以下載到完整的檔案？），因此就開始從網路架構方向調查，但幾經尋找測試均無果，只好回來系統本身。</p><h2>結論：執行逾時</h2><p>因為網站的流量很大，為了有效阻斷DDoS攻擊，因此我有特別設計一個檔案輸出類別，以二進制的方式來逐步輸出封包給瀏覽器，進而達到流量限制的效果，但這也意味著ASP.NET必須卡一個執行緒在上面執行，而最終的原因也是因為這個執行緒執行過久導致觸碰<code>執行逾時</code>關鍵值，直接被ASP.NET截斷發出<code>ThreadAbortException</code>例外錯誤。</p><p>我的檔案下載類別大約每秒輸出<code>512KB</code>到瀏覽器端，以客戶端的網路速度視角，大概是<code>512MB * 8 = 4096Mb</code>，也就是占用<code>4MB</code>的網路速度來下載檔案。這個數字對於一個並非服務檔案下載的HTTP伺服器，我認為撥補這樣的頻寬給使用者已經很合理了。</p><p>後來決定把<code>執行逾時</code>關鍵值調高至<code>600</code>秒也就是<code>10</code>分鐘，會有這樣的考慮是基於下面幾點：</p><ol><li>使用者可能處於速度比<code>4Mb</code>慢的網路環境。（雖然這樣的可能性已經越來越低）</li><li>若使用者可以用<code>4Mb</code>網路全速下載，那麼600秒大約可以下載<code>300MB</code>的檔案。（4Mb * 600s / 8 = 300MB）</li><li>搭配<code>maxRequestLength</code>將網站檔案限制在最大<code>200MB</code>容量，我認為是折衷後的最佳解。（慢速的給多一點時間下載提高檔案完整性，高速的限制流量以免耗損網站頻寬）</li></ol><p><code>web.config</code>檔案如下：</p><pre><code class=language-xml>&lt;system.web>
  &lt;httpRuntime executionTimeout="600" maxRequestLength="204800" />
&lt;/system.web>
</code></pre><p>以往認知<code>executionTimeout</code>參數時，並不會想到有可能觸發這方面的問題，在此筆記以供日後參考回憶。</p><h6>ASP.NET Big Huge FileDownload Break Broken Discontinue Suspend Web.Config ExecutionTimeout MaxRequestLength</h6></main><footer></footer><script src=/.file/site.js></script></body></html>